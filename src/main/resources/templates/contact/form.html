<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новый контакт</title>

    <div th:replace="fragments/styles :: base-styles"></div>
    <div th:replace="fragments/styles :: page-styles('forms')"></div>
    <style>
        .form-section {
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .dynamic-field {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }

        .add-field-btn {
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
        }

        .section-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-light">
<div th:replace="fragments/header :: header('Новый контакт',
    null, null, 'contacts')"></div>

<div class="container">
    <!-- Форма для создания -->
    <form th:action="@{/contacts}" th:object="${contactCreateDto}" method="post"
          class="needs-validation" novalidate>

        <!-- Basic Information -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-user me-2 text-primary"></i>Основная информация
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="firstName" class="form-label fw-semibold">
                            Имя <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="firstName"
                               th:field="*{firstName}" required placeholder="Введите имя">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('firstName')}"
                             th:errors="*{firstName}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="lastName" class="form-label fw-semibold">
                            Фамилия <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="lastName"
                               th:field="*{lastName}" required placeholder="Введите фамилию">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('lastName')}"
                             th:errors="*{lastName}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="displayName" class="form-label fw-semibold">Отображаемое имя</label>
                        <input type="text" class="form-control" id="displayName"
                               th:field="*{displayName}" placeholder="Имя для отображения">
                    </div>
                    <div class="col-md-6">
                        <label for="avatarUrl" class="form-label fw-semibold">URL аватара</label>
                        <div class="input-group">
                            <!--                            <span class="input-group-text bg-light">-->
                            <!--                                <i class="fas fa-link text-muted"></i>-->
                            <!--                            </span>-->
                            <input type="url" class="form-control" id="avatarUrl"
                                   th:field="*{avatarUrl}" placeholder="https://example.com/avatar.jpg">
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isFavorite"
                                   th:field="*{isFavorite}" role="switch">
                            <label class="form-check-label fw-semibold" for="isFavorite">
                                <i class="fas fa-star me-1 text-warning"></i>Добавить в избранное
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Details -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-address-book me-2 text-primary"></i>Способы связи
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addContactDetail()">
                    <i class="fas fa-plus me-2"></i>Добавить способ связи
                </button>
            </div>
            <div class="card-body">
                <div id="contactDetailsContainer" class="dynamic-fields-container">
                    <!-- Динамические поля добавляются здесь через JS -->
                </div>
            </div>
        </div>

        <!-- Social Profiles -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-globe me-2 text-primary"></i>Социальные профили
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addSocialProfile()">
                    <i class="fas fa-plus me-2"></i>Добавить профиль
                </button>
            </div>
            <div class="card-body">
                <div id="socialProfilesContainer" class="dynamic-fields-container">
                    <!-- Динамические поля добавляются здесь через JS -->
                </div>
            </div>
        </div>

        <!-- Company and Job Title -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-building me-2 text-primary"></i>Компания и должность
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addCompanyJobTitle()">
                    <i class="fas fa-plus me-2"></i>Добавить компанию и должность
                </button>
            </div>
            <div class="card-body">
                <div id="companyJobTitleContainer" class="dynamic-fields-container">
                    <!-- Динамические поля добавляются здесь через JS -->
                </div>
            </div>
        </div>

        <!-- Tags -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-tags me-2 text-primary"></i>Теги
                </h3>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-3">
                    <div th:each="tag : ${allTags}" class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                               th:id="'tag_' + ${tag.id}"
                               name="tagIds"
                               th:value="${tag.id}">
                        <label class="form-check-label" th:for="'tag_' + ${tag.id}">
                            <span class="badge bg-light text-dark border" th:text="${tag.name}"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-between align-items-center py-4">
            <a th:href="@{/contacts}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Назад к списку
            </a>
            <button type="submit" class="btn btn-success btn-lg px-5">
                <i class="fas fa-save me-2"></i>Создать контакт
            </button>
        </div>
    </form>
</div>

<!-- Hidden Templates -->
<div id="contactDetailTemplate" class="dynamic-field" style="display: none;">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label fw-semibold">Тип</label>
            <select class="form-select" name="contactDetailCreateDtos[INDEX].detailType">
                <option th:each="type : ${detailTypes}" th:value="${type}" th:text="${type}"></option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">Метка</label>
            <select class="form-select" name="contactDetailCreateDtos[INDEX].label">
                <option th:each="label : ${detailLabels}" th:value="${label}" th:text="${label}"></option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-semibold">Значение <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="contactDetailCreateDtos[INDEX].value">
        </div>
        <div class="col-md-2">
            <label class="form-label fw-semibold">Основной</label>
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" name="contactDetailCreateDtos[INDEX].isPrimary">
            </div>
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div id="socialProfileTemplate" class="dynamic-field" style="display: none;">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label fw-semibold">Платформа</label>
            <select class="form-select" name="socialProfileCreateDtos[INDEX].platform">
                <option th:each="platform : ${platforms}" th:value="${platform}" th:text="${platform}"></option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">Кастомная платформа</label>
            <input type="text" class="form-control" name="socialProfileCreateDtos[INDEX].customPlatformName"
                   placeholder="Если выбрано CUSTOM">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">Имя пользователя <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="socialProfileCreateDtos[INDEX].username">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">URL профиля</label>
            <input type="url" class="form-control" name="socialProfileCreateDtos[INDEX].profileUrl">
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div id="companyJobTitleTemplate" class="dynamic-field" style="display: none;">
    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label fw-semibold">Компания</label>
            <select class="form-select" name="contactCompanyCreateDtos[INDEX].companyId">
                <option value="">Выберите компанию</option>
                <option th:each="company : ${allCompanies}" th:value="${company.id}" th:text="${company.name}"></option>
            </select>
        </div>
        <div class="col-md-6">
            <label class="form-label fw-semibold">Должность</label>
            <select class="form-select" name="contactCompanyCreateDtos[INDEX].jobTitleId">
                <option value="">Выберите должность</option>
                <option th:each="jobTitle : ${allJobTitles}" th:value="${jobTitle.id}" th:text="${jobTitle.title}"></option>
            </select>
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div th:replace="fragments/footer :: footer"></div>
<div th:replace="fragments/scripts :: base-scripts"></div>

<script th:inline="javascript">
    window.addContactDetail = function() {
        var template = document.getElementById('contactDetailTemplate').cloneNode(true);
        template.removeAttribute('id');
        template.style.display = '';
        var index = document.getElementById('contactDetailsContainer').children.length;
        var elements = template.querySelectorAll('[name]');
        for (var i = 0; i < elements.length; i++) {
            elements[i].name = elements[i].name.replace('[INDEX]', '[' + index + ']');
        }
        document.getElementById('contactDetailsContainer').appendChild(template);
    };

    window.addSocialProfile = function() {
        var template = document.getElementById('socialProfileTemplate').cloneNode(true);
        template.removeAttribute('id');
        template.style.display = '';
        var index = document.getElementById('socialProfilesContainer').children.length;
        var elements = template.querySelectorAll('[name]');
        for (var i = 0; i < elements.length; i++) {
            elements[i].name = elements[i].name.replace('[INDEX]', '[' + index + ']');
        }
        document.getElementById('socialProfilesContainer').appendChild(template);
    };

    window.addCompanyJobTitle = function() {
        var template = document.getElementById('companyJobTitleTemplate').cloneNode(true);
        template.removeAttribute('id');
        template.style.display = '';
        var index = document.getElementById('companyJobTitleContainer').children.length;
        var elements = template.querySelectorAll('[name]');
        for (var i = 0; i < elements.length; i++) {
            elements[i].name = elements[i].name.replace('[INDEX]', '[' + index + ']');
        }
        document.getElementById('companyJobTitleContainer').appendChild(template);
    };

    window.removeFormField = function(button) {
        const field = button.closest('.dynamic-field');
        field.remove();
    };
</script>
</body>
</html>