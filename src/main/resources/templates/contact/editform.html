<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование контакта</title>

    <!-- Подключение стилей -->
    <div th:replace="fragments/styles :: base-styles"></div>
    <div th:replace="fragments/styles :: page-styles('forms')"></div>
</head>
<body class="bg-light">
<div th:replace="fragments/header :: header('Редактирование контакта', null, null, 'contacts')"></div>

<div class="container">
    <!-- Форма для редактирования -->
    <form th:action="@{/contacts/{id}/edit(id=${contactUpdateDto.id})}" th:object="${contactUpdateDto}" method="post"
          class="needs-validation" novalidate>

        <input type="hidden" th:field="*{id}" />

        <!-- Basic Information -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-user me-2 text-primary"></i>Основная информация
                </h3>
            </div>
            <div class="card-body">
                <div class="contact-form-grid">
                    <div class="contact-form-column">
                        <label for="firstName" class="form-label fw-semibold">
                            Имя <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="firstName"
                               th:field="*{firstName}" required placeholder="Введите имя">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('firstName')}"
                             th:errors="*{firstName}"></div>
                    </div>
                    <div class="contact-form-column">
                        <label for="lastName" class="form-label fw-semibold">
                            Фамилия <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="lastName"
                               th:field="*{lastName}" required placeholder="Введите фамилию">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('lastName')}"
                             th:errors="*{lastName}"></div>
                    </div>
                    <div class="contact-form-column">
                        <label for="displayName" class="form-label fw-semibold">Отображаемое имя</label>
                        <input type="text" class="form-control" id="displayName"
                               th:field="*{displayName}" placeholder="Имя для отображения">
                    </div>
                    <div class="contact-form-column">
                        <label for="avatarUrl" class="form-label fw-semibold">URL аватара</label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="avatarUrl"
                                   th:field="*{avatarUrl}" placeholder="https://example.com/avatar.jpg">
                        </div>
                    </div>
                    <div class="contact-form-full-width">
                        <div class="favorite-toggle">
                            <input type="checkbox" id="isFavorite"
                                   th:field="*{isFavorite}"
                                   class="favorite-checkbox" hidden
                                   onchange="updateFavoriteText(this)">
                            <label for="isFavorite" class="favorite-label">
                                <i class="favorite-icon far fa-star"></i>
                                <span class="favorite-text">Добавить в избранное</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Details -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-address-book me-2 text-primary"></i>Способы связи
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addContactDetail()">
                    <i class="fas fa-plus me-2"></i>Добавить способ связи
                </button>
            </div>
            <div class="card-body">
                <div id="contactDetailsContainer" class="dynamic-fields-container">
                    <div th:each="detail, stat : *{contactDetails}" class="dynamic-field">
                        <input type="hidden" th:field="*{contactDetails[__${stat.index}__].id}" />
                        <div class="contact-detail-grid">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Тип</label>
                                <select class="form-select" th:field="*{contactDetails[__${stat.index}__].detailType}" required>
                                    <option value="" disabled>Выберите тип</option>
                                    <option th:each="type : ${detailTypes}" th:value="${type.name()}" th:text="${type}"
                                            th:selected="${detail.detailType.name() == type.name()}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('contactDetails[__${stat.index}__].detailType')}">
                                    Тип обязателен
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Метка</label>
                                <select class="form-select" th:field="*{contactDetails[__${stat.index}__].label}" required>
                                    <option value="" disabled>Выберите метку</option>
                                    <option th:each="label : ${detailLabels}" th:value="${label.name()}" th:text="${label}"
                                            th:selected="${detail.label.name() == label.name()}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('contactDetails[__${stat.index}__].label')}">
                                    Метка обязательна
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Значение <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{contactDetails[__${stat.index}__].value}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('contactDetails[__${stat.index}__].value')}">
                                    Значение обязательно
                                </div>
                            </div>
                            <div class="contact-form-full-width">
                                <div class="primary-toggle">
                                    <input type="checkbox" name="contactDetailCreateDtos[INDEX].isPrimary"
                                           th:field="*{contactDetails[__${stat.index}__].isPrimary}"
                                           class="primary-checkbox" hidden
                                           onchange="updatePrimaryText(this)">
                                    <label class="primary-label" onclick="togglePrimaryCheckbox(this)">
                                        <i class="primary-icon far fa-circle"></i>
                                        <span class="primary-text">Сделать основным</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
                            <i class="fas fa-trash me-1"></i>Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Social Profiles -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-globe me-2 text-primary"></i>Социальные профили
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addSocialProfile()">
                    <i class="fas fa-plus me-2"></i>Добавить профиль
                </button>
            </div>
            <div class="card-body">
                <div id="socialProfilesContainer" class="dynamic-fields-container">
                    <div th:each="profile, stat : *{socialProfiles}" class="dynamic-field">
                        <input type="hidden" th:field="*{socialProfiles[__${stat.index}__].id}" />
                        <div class="contact-detail-grid">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Платформа</label>
                                <select class="form-select" th:field="*{socialProfiles[__${stat.index}__].platform}" required>
                                    <option value="" disabled>Выберите платформу</option>
                                    <option th:each="platform : ${platforms}" th:value="${platform.name()}" th:text="${platform}"
                                            th:selected="${profile.platform.name() == platform.name()}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('socialProfiles[__${stat.index}__].platform')}">
                                    Платформа обязательна
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Кастомная платформа</label>
                                <input type="text" class="form-control" th:field="*{socialProfiles[__${stat.index}__].customPlatformName}"
                                       placeholder="Если выбрано CUSTOM">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Имя пользователя <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{socialProfiles[__${stat.index}__].username}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('socialProfiles[__${stat.index}__].username')}">
                                    Имя пользователя обязательно
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">URL профиля</label>
                                <input type="url" class="form-control" th:field="*{socialProfiles[__${stat.index}__].profileUrl}">
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
                            <i class="fas fa-trash me-1"></i>Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Company and Job Title -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-building me-2 text-primary"></i>Компания и должность
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addCompanyJobTitle()">
                    <i class="fas fa-plus me-2"></i>Добавить компанию и должность
                </button>
            </div>
            <div class="card-body">
                <div id="companyJobTitleContainer" class="dynamic-fields-container">
                    <div th:each="company, stat : *{companies}" class="dynamic-field">
                        <input type="hidden" th:field="*{companies[__${stat.index}__].id}" />
                        <div class="contact-detail-grid">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Компания</label>
                                <select class="form-select" th:field="*{companies[__${stat.index}__].companyId}">
                                    <option value="" disabled>Выберите компанию</option>
                                    <option th:each="comp : ${allCompanies}" th:value="${comp.id}" th:text="${comp.name}"
                                            th:selected="${company.companyId == comp.id}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Должность</label>
                                <select class="form-select" th:field="*{companies[__${stat.index}__].jobTitleId}">
                                    <option value="" disabled>Выберите должность</option>
                                    <option th:each="job : ${allJobTitles}" th:value="${job.id}" th:text="${job.title}"
                                            th:selected="${company.jobTitleId == job.id}"></option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
                            <i class="fas fa-trash me-1"></i>Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Events -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-calendar me-2 text-primary"></i>События
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addEvent()">
                    <i class="fas fa-plus me-2"></i>Добавить событие
                </button>
            </div>
            <div class="card-body">
                <div id="eventsContainer" class="dynamic-fields-container">
                    <div th:each="event, stat : *{events}" class="dynamic-field">
                        <input type="hidden" th:field="*{events[__${stat.index}__].id}" />
                        <div class="contact-detail-grid">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Тип события</label>
                                <select class="form-select" th:field="*{events[__${stat.index}__].eventType}" required>
                                    <option value="" disabled>Выберите тип</option>
                                    <option th:each="type : ${eventTypes}" th:value="${type.name()}" th:text="${type}"
                                            th:selected="${event.eventType.name() == type.name()}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('events[__${stat.index}__].eventType')}">
                                    Тип обязателен
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Кастомное имя</label>
                                <input type="text" class="form-control" th:field="*{events[__${stat.index}__].customEventName}"
                                       placeholder="Если CUSTOM">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Дата события <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" th:field="*{events[__${stat.index}__].eventDate}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('events[__${stat.index}__].eventDate')}">
                                    Дата обязательна
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Заметки</label>
                                <textarea class="form-control" th:field="*{events[__${stat.index}__].notes}"></textarea>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Ежегодное повторение</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" th:field="*{events[__${stat.index}__].yearlyRecurrence}">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
                            <i class="fas fa-trash me-1"></i>Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-note-sticky me-2 text-primary"></i>Заметки
                </h3>
                <button type="button" class="btn btn-primary add-field-btn" onclick="window.addNote()">
                    <i class="fas fa-plus me-2"></i>Добавить заметку
                </button>
            </div>
            <div class="card-body">
                <div id="notesContainer" class="dynamic-fields-container">
                    <div th:each="note, stat : *{notes}" class="dynamic-field">
                        <input type="hidden" th:field="*{notes[__${stat.index}__].id}" />
                        <div class="contact-detail-grid">
                            <div class="col-12">
                                <label class="form-label fw-semibold">Содержимое <span class="text-danger">*</span></label>
                                <textarea class="form-control" th:field="*{notes[__${stat.index}__].content}" required></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('notes[__${stat.index}__].content')}">
                                    Содержимое обязательно
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
                            <i class="fas fa-trash me-1"></i>Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tags -->
        <div class="card form-section shadow-sm mb-4">
            <div class="card-header bg-white">
                <h3 class="h5 fw-bold mb-0 section-header">
                    <i class="fas fa-tags me-2 text-primary"></i>Теги
                </h3>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-3">
                    <div th:each="tag : ${allTags}" class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                               th:id="'tag_' + ${tag.id}"
                               name="tagIds"
                               th:value="${tag.id}"
                               th:checked="${contactUpdateDto.tagIds.contains(tag.id)}">
                        <label class="form-check-label" th:for="'tag_' + ${tag.id}">
                            <span class="badge bg-light text-dark border" th:text="${tag.name}"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-between align-items-center py-4">
            <a th:href="@{/contacts}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Назад к списку
            </a>
            <button type="submit" class="btn btn-success btn-lg px-5">
                <i class="fas fa-save me-2"></i>Сохранить изменения
            </button>
        </div>
    </form>
</div>

<!-- Hidden Templates for Adding New -->
<div id="contactDetailTemplate" class="dynamic-field" style="display: none;">
    <div class="contact-detail-grid">
        <div class="contact-form-column">
            <label class="form-label fw-semibold">Тип</label>
            <select class="form-select" name="contactDetails[INDEX].detailType" required>
                <option value="" disabled selected>Выберите тип</option>
                <option th:each="type : ${detailTypes}" th:value="${type.name()}" th:text="${type}"></option>
            </select>
            <div class="invalid-feedback">Тип обязателен</div>
        </div>
        <div class="contact-form-column">
            <label class="form-label fw-semibold">Метка</label>
            <select class="form-select" name="contactDetails[INDEX].label" required>
                <option value="" disabled selected>Выберите метку</option>
                <option th:each="label : ${detailLabels}" th:value="${label.name()}" th:text="${label}"></option>
            </select>
            <div class="invalid-feedback">Метка обязательна</div>
        </div>
        <div class="contact-form-column">
            <label class="form-label fw-semibold">Значение <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="contactDetails[INDEX].value" required>
            <div class="invalid-feedback">Значение обязательно</div>
        </div>
        <div class="contact-form-column">
            <label class="form-label fw-semibold">Основной</label>
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" name="contactDetails[INDEX].isPrimary">
            </div>
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div id="socialProfileTemplate" class="dynamic-field" style="display: none;">
    <div class="contact-form-grid">
        <div class="contact-form-column">
            <label class="form-label fw-semibold">Платформа</label>
            <select class="form-select" name="socialProfiles[INDEX].platform" required>
                <option value="" disabled selected>Выберите платформу</option>
                <option th:each="platform : ${platforms}" th:value="${platform.name()}" th:text="${platform}"></option>
            </select>
            <div class="invalid-feedback">Платформа обязательна</div>
        </div>
        <div class="contact-form-column">
            <label class="form-label fw-semibold">Кастомная платформа</label>
            <input type="text" class="form-control" name="socialProfiles[INDEX].customPlatformName"
                   placeholder="Если выбрано CUSTOM">
        </div>
        <div class="contact-form-column">
            <label class="form-label fw-semibold">Имя пользователя <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="socialProfiles[INDEX].username" required>
            <div class="invalid-feedback">Имя пользователя обязательно</div>
        </div>
        <div class="contact-form-column">
            <label class="form-label fw-semibold">URL профиля</label>
            <input type="url" class="form-control" name="socialProfiles[INDEX].profileUrl">
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div id="companyJobTitleTemplate" class="dynamic-field" style="display: none;">
    <div class="contact-detail-grid">
        <div class="col-md-6">
            <label class="form-label fw-semibold">Компания</label>
            <select class="form-select" name="companies[INDEX].companyId">
                <option value="" disabled selected>Выберите компанию</option>
                <option th:each="comp : ${allCompanies}" th:value="${comp.id}" th:text="${comp.name}"></option>
            </select>
        </div>
        <div class="col-md-6">
            <label class="form-label fw-semibold">Должность</label>
            <select class="form-select" name="companies[INDEX].jobTitleId">
                <option value="" disabled selected>Выберите должность</option>
                <option th:each="job : ${allJobTitles}" th:value="${job.id}" th:text="${job.title}"></option>
            </select>
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div id="eventTemplate" class="dynamic-field" style="display: none;">
    <div class="contact-detail-grid">
        <div class="col-md-3">
            <label class="form-label fw-semibold">Тип события</label>
            <select class="form-select" name="events[INDEX].eventType" required>
                <option value="" disabled selected>Выберите тип</option>
                <option th:each="type : ${eventTypes}" th:value="${type.name()}" th:text="${type}"></option>
            </select>
            <div class="invalid-feedback">Тип обязателен</div>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">Кастомное имя</label>
            <input type="text" class="form-control" name="events[INDEX].customEventName"
                   placeholder="Если CUSTOM">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">Дата события <span class="text-danger">*</span></label>
            <input type="date" class="form-control" name="events[INDEX].eventDate" required>
            <div class="invalid-feedback">Дата обязательна</div>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">Заметки</label>
            <textarea class="form-control" name="events[INDEX].notes"></textarea>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-semibold">Ежегодное повторение</label>
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" name="events[INDEX].yearlyRecurrence">
            </div>
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div id="noteTemplate" class="dynamic-field" style="display: none;">
    <div class="contact-detail-grid">
        <div class="col-12">
            <label class="form-label fw-semibold">Содержимое <span class="text-danger">*</span></label>
            <textarea class="form-control" name="notes[INDEX].content" required></textarea>
            <div class="invalid-feedback">Содержимое обязательно</div>
        </div>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-3" onclick="window.removeFormField(this)">
        <i class="fas fa-trash me-1"></i>Удалить
    </button>
</div>

<div th:replace="fragments/footer :: footer"></div>
<div th:replace="fragments/scripts :: base-scripts"></div>
<div th:replace="fragments/scripts :: page-scripts('contact-forms')"></div>
</body>
</html>